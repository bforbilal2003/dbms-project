CREATE TABLE User1 (
    email VARCHAR(255) PRIMARY KEY NOT NULL,
    name VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
	lastLogin TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX user_email_idx ON User1 (email);

INSERT INTO User1 (email, name, password) VALUES ('testing@gmail.com', 'haseeb', 'hello123');

CREATE TABLE reservation (
    reservationID BIGINT PRIMARY KEY,
    reservedBy VARCHAR(30),
    roomType VARCHAR(20),
    reservationDate DATE,
    checkoutDate DATE,
    FOREIGN KEY (reservedBy) REFERENCES User1 (email)
);

CREATE INDEX reservation_reservedBy_idx ON reservation (reservedBy);
CREATE INDEX reservation_roomType_idx ON reservation (roomType);

CREATE TABLE delux (
    reservationID BIGINT PRIMARY KEY,
    price BIGINT,
    isAvailable BOOLEAN,
    maxNoOfPeople INT
);

CREATE TABLE premium (
    reservationID BIGINT PRIMARY KEY,
    price BIGINT,
    isAvailable BOOLEAN,
    maxNoOfPeople INT
);

CREATE TABLE suite (
    reservationID BIGINT PRIMARY KEY,
    price BIGINT,
    isAvailable BOOLEAN,
    maxNoOfPeople INT
);

CREATE OR REPLACE FUNCTION InsertIntoRoomTables()
RETURNS TRIGGER AS $$
BEGIN
    IF (NEW.roomType = 'delux') THEN
        INSERT INTO delux (reservationID, price, isAvailable, maxNoOfPeople)
        VALUES (NEW.reservationID, 100, true, 2);
    ELSIF (NEW.roomType = 'premium') THEN
        INSERT INTO premium (reservationID, price, isAvailable, maxNoOfPeople)
        VALUES (NEW.reservationID, 500, true, 4);
    ELSE
        INSERT INTO suite (reservationID, price, isAvailable, maxNoOfPeople)
        VALUES (NEW.reservationID, 1000, true, 6);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_into_room_tables_trigger
AFTER INSERT ON reservation
FOR EACH ROW
EXECUTE FUNCTION InsertIntoRoomTables();

CREATE OR REPLACE PROCEDURE GetUserReservationsCursor(
    IN currentUserEmail VARCHAR(30)
)
LANGUAGE plpgsql
AS $$
DECLARE
    user_reservation_cursor CURSOR FOR
        SELECT u.email, u.name, r.reservationID, r.roomType, r.reservationDate, r.checkoutDate
        FROM "User" u
        INNER JOIN reservation r ON u.email = r.reservedBy
        WHERE u.email = currentUserEmail;
    row_record RECORD;
BEGIN
    -- Open the cursor
    OPEN user_reservation_cursor;

    -- Fetch rows from the cursor and return each row
    FOR row_record IN user_reservation_cursor LOOP
        -- Output each row to the result set
        -- This is equivalent to RETURN NEXT in a set-returning function
        SELECT row_record.email, row_record.name, row_record.reservationID, row_record.roomType, row_record.reservationDate, row_record.checkoutDate;
    END LOOP;

    -- Close the cursor
    CLOSE user_reservation_cursor;
END;
$$;
